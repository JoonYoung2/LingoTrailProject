<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

<style>
  /* Custom styles for the game page */
  .game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .game-question {
    text-align: center;
    margin-top: 20px;
    margin-bottom: 0;
  }

  .game-image {
      width: 100%;
      max-height: 300px;
      border-radius: 10px;
      object-fit: cover;
    }

  .game-explain {
    text-align: center;
  }

  .game-answer-form {
    text-align: center;
    margin-bottom: auto;
  }

 .game-next-button {
    text-align: center;
  }

  .game-progress {
      margin-top: 20px;
      width: 100%;
    }
</style>

<body>
  <div class="container game-container">
    <div class="game-question">
      <img src="/static/game1_files/<%= currentQuestion.IMG %>" class="game-image" alt="Question Image">
      <p><%= currentQuestion.QUESTION %></p>
    </div>

    <div class="game-result">
      <% if (explain) { %>
        <div class="game-explain alert alert-info">
          <%= explain %>
        </div>
      <% } %>
    </div>

    <div class="heart-icons">
      <% for (let i = 0; i < heartCount; i++) { %>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="pink" class="bi bi-heart-fill" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
        </svg>
      <% } %>
    </div>


    <div class="game-answer-form">
      <form action="/game1/checkAnswer" method="post">
        <input type="hidden" name="record_id" value="<%= currentQuestion.RECORD_ID %>">
        <br><br>
        <% const options=[currentQuestion.WRONG1, currentQuestion.WRONG2, currentQuestion.WRONG3, currentQuestion.ANSWER];options.sort(() => Math.random() - 0.5);options.forEach((option, index) => { %>
          <input type="radio" class="btn-check" name="selected_answer" id="option<%= index + 1 %>" value="<%= option %>" <% if (explain !== undefined)  { %>disabled <% } %>>
          <label class="btn" for="option<%= index + 1 %>"><%= option %></label>
        <% }); %>
        <br><br>
        <button type="submit" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#answerModal">문제확인</button> <!-- 검증 버튼 추가 -->
      </form>        
      </form>
    </div>

    <div class="game-next-button">
      <a href="/game1/next" class="btn btn-secondary">다음 문제</a>
    </div>

  <div class="progress" role="progressbar" aria-label="Animated striped example" style="height: 30px; margin: 0 auto; width: 50%; margin: 20;">
    <div class="progress-bar progress-bar-striped progress-bar-animated"  style="width: <%= (nextIndex + 1) * 20 %>%" aria-valuenow="<%= (nextIndex + 1) * 20 %>" aria-valuemin="0" aria-valuemax="100"></div>
  </div> 

  <!-- modal -->
  <div class="modal fade" id="heartZeroModal" tabindex="-1" aria-labelledby="heartZeroModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="heartZeroModalLabel">하트 소진</h5>
          <a href="/game1/list"><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></a>
        </div>
        <div class="modal-body">
          하트가 모두 소진되었습니다.
        </div>
        <div class="modal-footer">
          <a href="/game1/list" class="btn btn-primary">홈으로 가기</a>
        </div>
      </div>
    </div>
  </div>
</body>

<!-- 정답 선택 모달 -->
<div class="modal fade" id="selectAnswerModal" tabindex="-1" aria-labelledby="selectAnswerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="selectAnswerModalLabel">알림</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        정답을 선택해주세요.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
      </div>
    </div>
  </div>
</div>

<script>
  // 페이지가 새로고침되었을
  if (performance.navigation.type === 1) {
    alert("다시 시작해주세요");
    window.location.href = "/game1/list"; 
  }

  document.addEventListener("DOMContentLoaded", function() {
    // 페이지가 로딩되었을 때 하트 개수가 0이면 모달 창을 띄웁니다.
    if (<%= heartCount %>=== 0) {
      const heartZeroModal = new bootstrap.Modal(document.getElementById("heartZeroModal"));
      heartZeroModal.show();
    }

    const checkAnswerButton = document.querySelector(".game-answer-form button[type='submit']");
    checkAnswerButton.addEventListener("click", function(event) {
    const selectedAnswer = document.querySelector(".game-answer-form input[name='selected_answer']:checked");
    if (!selectedAnswer) {
      event.preventDefault(); // 버튼의 기본 동작 막기
      const selectAnswerModal = new bootstrap.Modal(document.getElementById("selectAnswerModal"));
      selectAnswerModal.show();
    }
  });
  });
</script>